openapi: 3.0.3
info:
  title: Whot2Watch REST API (Fallback)
  version: '0.1.0'
servers:
  - url: https://api.whot2watch.example.com/v1
paths:
  /admin/refresh/tmdb/{tmdbId}:
    post:
      summary: Admin refresh by TMDB ID (enrich imdbId and ratings; reindex)
      parameters:
        - in: path
          name: tmdbId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  imdbId: { type: string, nullable: true }
                  ratingsUpserts: { type: integer }
        '401': { description: unauthorized }
        '403': { description: forbidden }
        '404': { description: not found }
  /admin/refresh/imdb/{imdbId}:
    post:
      summary: Admin refresh by IMDB ID (ratings upsert; reindex)
      parameters:
        - in: path
          name: imdbId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  ratingsUpserts: { type: integer }
        '401': { description: unauthorized }
        '403': { description: forbidden }
        '404': { description: not found }
  /picks:
    get:
      summary: Get daily picks for a profile
      parameters:
        - in: query
          name: profileId
          schema: { type: string, format: uuid }
          required: true
        - in: query
          name: limit
          schema: { type: integer, default: 5, minimum: 1, maximum: 10 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Recommendation'
  /search:
    get:
      summary: Search titles
      parameters:
        - in: query
          name: q
          schema: { type: string }
        - in: query
          name: region
          schema: { $ref: '#/components/schemas/Region' }
        - in: query
          name: providerIn
          schema:
            type: array
            items: { $ref: '#/components/schemas/Provider' }
          style: form
          explode: false
        - in: query
          name: runtimeLt
          schema: { type: integer }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Title' }
                  nextCursor:
                    type: string
  /availability/{titleId}:
    get:
      summary: Get availability for a title
      parameters:
        - in: path
          name: titleId
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: region
          schema: { $ref: '#/components/schemas/Region' }
        - in: query
          name: services
          schema:
            type: array
            items: { $ref: '#/components/schemas/Provider' }
          style: form
          explode: false
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Availability' }
  /lists:
    get:
      summary: List user lists
      parameters:
        - in: query
          name: profileId
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: visibility
          schema: { type: string, enum: [PRIVATE, FRIENDS, PUBLIC, COLLAB] }
        - in: query
          name: first
          schema: { type: integer, default: 20 }
        - in: query
          name: after
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/List' }
                  nextCursor: { type: string }
  /alerts:
    get:
      summary: List alerts
      parameters:
        - in: query
          name: profileId
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: status
          schema: { type: string, enum: [ACTIVE, FIRED, CANCELLED] }
        - in: query
          name: first
          schema: { type: integer, default: 20 }
        - in: query
          name: after
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items: { type: array, items: { type: object } }
                  nextCursor: { type: string }
  /subscriptions:
    get:
      summary: List subscriptions
      parameters:
        - in: query
          name: profileId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Subscription' }
  /group-sessions:
    get:
      summary: List group sessions
      parameters:
        - in: query
          name: hostProfileId
          schema: { type: string, format: uuid }
        - in: query
          name: participantProfileId
          schema: { type: string, format: uuid }
        - in: query
          name: status
          schema: { type: string, enum: [open, locked, closed] }
        - in: query
          name: first
          schema: { type: integer, default: 20 }
        - in: query
          name: after
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items: { type: array, items: { $ref: '#/components/schemas/GroupSession' } }
                  nextCursor: { type: string }
  /profiles/{profileId}/tier:
    get:
      operationId: getProfileTier
      summary: Get user tier and daily chat quota
      parameters:
        - in: path
          name: profileId
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  tier: { type: string, enum: [free, premium] }
                  quota: { $ref: '#/components/schemas/ChatQuota' }
  /nlu/parse:
    get:
      operationId: nluParse
      summary: Parse a natural-language query into structured search entities
      description: >
        Extracts genres, services, moods, duration, year, and region from
        a conversational query. Returns cleaned query text with entity
        phrases stripped.
      parameters:
        - in: query
          name: q
          required: true
          schema: { type: string }
          description: Natural-language search query
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/NluParseResult' }
        '400':
          description: Missing or empty q parameter
        '503':
          description: NLU feature is disabled
  /plans/status/{userId}:
    get:
      operationId: getPlanStatus
      summary: Get current plan status for a user
      parameters:
        - in: path
          name: userId
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlanStatus' }
  /plans/trial:
    post:
      operationId: startTrial
      summary: Start a 14-day premium trial
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlanSubscriptionRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlanStatus' }
  /plans/subscribe:
    post:
      operationId: subscribePlan
      summary: Subscribe to premium (mocked billing)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlanSubscriptionRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlanStatus' }
  /plans/cancel:
    post:
      operationId: cancelPlan
      summary: Cancel premium subscription
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PlanSubscriptionRequest' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PlanStatus' }
  /affiliates/disclosure:
    get:
      operationId: getAffiliateDisclosure
      summary: Get affiliate disclosure text and status
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AffiliateDisclosure' }
  /social/analytics/{profileId}:
    get:
      operationId: getSocialAnalytics
      summary: Premium social analytics for a profile
      parameters:
        - in: path
          name: profileId
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/SocialAnalytics' }
        '403':
          description: Premium required
  /referrals/generate:
    post:
      operationId: generateReferralCode
      summary: Generate or return existing referral code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId: { type: string, format: uuid }
              required: [userId]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReferralCode' }
  /referrals/redeem:
    post:
      operationId: redeemReferralCode
      summary: Redeem a referral code
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code: { type: string }
                redeemedByUserId: { type: string, format: uuid }
              required: [code, redeemedByUserId]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
  /referrals/stats/{userId}:
    get:
      operationId: getReferralStats
      summary: Get referral statistics for a user
      parameters:
        - in: path
          name: userId
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReferralStats' }
  /embed/{listId}:
    get:
      operationId: getEmbed
      summary: Embeddable read-only list widget
      parameters:
        - in: path
          name: listId
          schema: { type: string, format: uuid }
          required: true
      responses:
        '200':
          description: OK
          content:
            text/html:
              schema: { type: string }
        '404':
          description: List not found or not public
  /admin/demo-dashboard:
    get:
      operationId: getDemoDashboard
      summary: Demo dashboard with aggregate stats (admin-gated)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/DemoDashboard' }
        '403':
          description: Admin access required
components:
  schemas:
    PlanStatus:
      type: object
      properties:
        plan: { type: string, enum: [free, premium] }
        status: { type: string, enum: [active, trial, cancelled, expired] }
        trialEndsAt: { type: string, format: date-time, nullable: true }
        subscribedAt: { type: string, format: date-time, nullable: true }
        cancelledAt: { type: string, format: date-time, nullable: true }
        features: { type: array, items: { type: string } }
      required: [plan, status, features]
    PlanSubscriptionRequest:
      type: object
      properties:
        userId: { type: string, format: uuid }
      required: [userId]
    AffiliateDisclosure:
      type: object
      properties:
        enabled: { type: boolean }
        text: { type: string, nullable: true }
    SocialAnalytics:
      type: object
      properties:
        topGenresAmongFriends: { type: array, items: { type: object } }
        friendsWatchingNow: { type: integer }
        sharedTitles: { type: integer }
        topServicesAmongFriends: { type: array, items: { type: object } }
    ReferralCode:
      type: object
      properties:
        code: { type: string }
        userId: { type: string, format: uuid }
        maxUses: { type: integer }
        redemptions: { type: integer }
    ReferralStats:
      type: object
      properties:
        code: { type: string }
        totalReferred: { type: integer }
        activeReferred: { type: integer }
    DemoDashboard:
      type: object
      properties:
        totalUsers: { type: integer }
        premiumUsers: { type: integer }
        totalReferrals: { type: integer }
        topTrending: { type: array, items: { type: object } }
    Region:
      type: string
      enum: [US, CA, GB, AU, IN]
    Provider:
      type: string
      enum:
        [
          NETFLIX,
          AMAZON_PRIME_VIDEO,
          DISNEY_PLUS,
          HULU,
          MAX,
          APPLE_TV_PLUS,
          PARAMOUNT_PLUS,
          PEACOCK,
          CRUNCHYROLL,
          TUBI,
          OTHER,
        ]
    Availability:
      type: object
      properties:
        service: { $ref: '#/components/schemas/Provider' }
        region: { $ref: '#/components/schemas/Region' }
        offerType: { type: string, enum: [SUBSCRIPTION, RENT, BUY, FREE] }
        deepLink: { type: string }
        lastSeenAt: { type: string, format: date-time }
    Title:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        type: { type: string, enum: [MOVIE, SHOW] }
        releaseYear: { type: integer }
        runtimeMin: { type: integer }
        genres: { type: array, items: { type: string } }
        moods: { type: array, items: { type: string } }
        posterUrl: { type: string }
        backdropUrl: { type: string }
        overview: { type: string }
        voteAverage: { type: number }
        popularity: { type: number }
        availability:
          type: array
          items: { $ref: '#/components/schemas/Availability' }
    Recommendation:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { $ref: '#/components/schemas/Title' }
        score: { type: number }
        reason: { type: string }
        createdAt: { type: string, format: date-time }
    Subscription:
      type: object
      properties:
        id: { type: string, format: uuid }
        service: { $ref: '#/components/schemas/Provider' }
        region: { $ref: '#/components/schemas/Region' }
        active: { type: boolean }
        createdAt: { type: string, format: date-time }
    List:
      type: object
      properties:
        id: { type: string, format: uuid }
        ownerProfileId: { type: string, format: uuid }
        name: { type: string }
        visibility: { type: string, enum: [PRIVATE, FRIENDS, PUBLIC, COLLAB] }
        description: { type: string }
        createdAt: { type: string, format: date-time }
    GroupSession:
      type: object
      properties:
        id: { type: string, format: uuid }
        hostProfileId: { type: string, format: uuid }
        name: { type: string }
        constraints: { type: object }
        status: { type: string, enum: [open, locked, closed] }
        createdAt: { type: string, format: date-time }
    ChatQuota:
      type: object
      properties:
        used: { type: integer }
        limit: { type: integer }
        remaining: { type: integer }
        resetsAt: { type: string, format: date-time }
    NluParseResult:
      type: object
      required: [originalQuery, cleanQuery, entities]
      properties:
        originalQuery: { type: string }
        cleanQuery: { type: string }
        entities: { $ref: '#/components/schemas/ExtractedEntities' }
    ExtractedEntities:
      type: object
      properties:
        genres: { type: array, items: { type: string } }
        services: { type: array, items: { type: string } }
        moods: { type: array, items: { type: string } }
        titles: { type: array, items: { type: string } }
        duration:
          type: object
          properties:
            min: { type: integer }
            max: { type: integer }
        releaseYear:
          type: object
          properties:
            min: { type: integer }
            max: { type: integer }
        region: { type: string }
