name: Nightly Enrich and Reindex

on:
  schedule:
    - cron: '0 3 * * *' # 03:00 UTC daily
  workflow_dispatch: {}

jobs:
  enrich:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: w2w
          POSTGRES_PASSWORD: w2w
          POSTGRES_DB: w2w
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U w2w" --health-interval 10s --health-timeout 5s --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
      opensearch:
        image: opensearchproject/opensearch:2.14.0
        env:
          discovery.type: single-node
          plugins.security.disabled: 'true'
          OPENSEARCH_JAVA_OPTS: -Xms512m -Xmx512m
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl -fsSL http://localhost:9200 >/dev/null || exit 1" --health-interval 15s --health-timeout 5s --health-retries 20

    env:
      NODE_ENV: production
      DATABASE_URL: postgresql://w2w:w2w@localhost:5432/w2w?schema=public
      REDIS_URL: redis://localhost:6379
      OPENSEARCH_URL: http://localhost:9200
      OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TMDB_ACCESS_TOKEN: ${{ secrets.TMDB_ACCESS_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install deps
        run: pnpm install --frozen-lockfile=false

      - name: Wait for services
        run: |
          for i in {1..60}; do
            (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1 && break || sleep 2;
          done
          for i in {1..60}; do
            curl -fsSL http://127.0.0.1:9200 >/dev/null && break || sleep 2;
          done
          for i in {1..60}; do
            (echo > /dev/tcp/127.0.0.1/6379) >/dev/null 2>&1 && break || sleep 2;
          done

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Migrate DB
        run: pnpm prisma:migrate:deploy

      - name: Seed DB (optional)
        run: pnpm db:seed

      - name: Run nightly pipeline
        run: pnpm pipeline:nightly
